<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Tesselation</title>

	<script type="text/javascript" src="./d3/d3.js"></script>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h2>Tesselation</h2>
        <p>M. C. Escher&#39;s reptile tesselations and d3</p>
      </header>
      <section>
    		<script type="text/javascript">

			//Width and height
			var w = 840;
			var h = 760;
			  
			var svg = d3.select("body")
						.append("svg")
						.attr("width", w)
						.attr("height", h);
			
			var lizard = false;
		
			var getPointByAngle = function(r, x, y, angle) {
				return { "x": (x + r * Math.sin(Math.PI * angle / 180)),  "y": (y + r * Math.cos(Math.PI * angle / 180))}; 
			}
			
			var getNextPoint = function(point, angle, dist) {
				return { "x": point.x + dist * (Math.sin(angle)), "y": (point.y + dist * Math.cos(angle)) };
			}
			
			var addLinePoints = function(points, refPoint, angle, numPoints, r) {
				for (var i = 0; i < numPoints; i++) {
					points.push(getNextPoint(refPoint, angle * Math.PI / 180, i * r / (numPoints - 1)));
				}	
			}
			
			var getGenericPoints = function(r, x, y, angle) {
				var points = [];
				for (var i = 0; i < 6; i++) {
					var reference = getPointByAngle(r, x, y, angle + 90 + i * 60);
					addLinePoints(points, reference, angle - 150 + i * 60, (i == 2 || i == 3) ? 8 : 10, r);
				}	
				return points;
			}
			
			var addPoints = function(points, refPoint, refAngle, angles, distances, reversed) {
				for (var i = 0; i < angles.length; i++) {
					var num = reversed ? angles.length - 1 - i : i;
					var angle = (refAngle + angles[num]) * Math.PI / 180;
					points.push(getNextPoint(refPoint, angle, distances[num]));
				}
			}			
			
			var getLizardPoints = function(r, x, y, startAngle) {
				var points = [];
				var angle = 90 + startAngle;
				var refAngle = -90 + startAngle;
				
				var angles = [[0, 50, 28, 32, 60, 68, 120, 154, 150, 120],[0, 24, 51, 60, 114, 96, 78, 60],[0, -58, -41, -32, 12.5,  23, 19, 24, 18, 0]];				
				var distances = [[0, 0.24*r, 0.28*r, 0.43*r, 0.52*r, 0.514*r, 0.25*r, 0.625*r, 0.764*r, r],
								[0, 0.35*r, 0.47*r, 0.7*r, 0.77*r, 1.09*r, 0.93* r,r],
								[0, 0.52*r, 0.82*r, 0.45*r, 0.36*r, 0.47*r, 0.875*r, 0.99 *r, 1.17*r, r]];
				
				var reference = getPointByAngle(r, x, y, angle);			
				
				for (var i = 0; i < 3; i++) {
					angle += 120;
					refAngle -= 180;
					addPoints(points, reference, refAngle, angles[i], distances[i], false);
					reference = getPointByAngle(r, x, y, angle);
					addPoints(points, reference, refAngle - 120, angles[i], distances[i], true);
				}
				
				return points;
			}
			
			var lineFunction = d3.svg.line()
                          .x(function(d) { return d.x; })
                          .y(function(d) { return d.y; })
                          .interpolate("linear");
            
			var r = 45;
			var x = 500;
			var y = 0;
			
			var colors = ["#181C7F", "#7D82FF", "#3138FF", "#9467bd"];
			var angles = [0, 120, 240];
			var dataset = [];
			var num = 0;
			
			for (var i = 0; i < 5; i++) {
				y += 3 * r * Math.cos( Math.PI / 6);
				x -= 2 * r * Math.cos( Math.PI / 6) * Math.cos(Math.PI / 6);
				num++;
				for (var j = 0; j < num; j++) {
					dataset.push({"r" : r, "x": x + j * r * 3, "y": y, "angle": angles[0], "color": colors[0]});
					dataset.push({"r" : r, "x": x + j * r * 3, "y": y + 2 * r * Math.cos( Math.PI / 6), "angle": angles[1], "color": colors[1]});
					dataset.push({"r" : r, "x": x + j * r * 3 + 2 * r * Math.cos( Math.PI / 6) * Math.cos(Math.PI / 6), "y": y + r * Math.cos(Math.PI / 6), "angle": angles[2], "color": colors[2]});
				}
			}
			
			svg.selectAll("path")
			   .data(dataset)
			   .enter()
			   .append("path")
			   .attr("d", function(d) {
			  		return lineFunction(getLizardPoints(d.r, d.x, d.y, d.angle));
			   })
			   .attr("stroke", function(d) {
					return d.color;
			   })
               .attr("stroke-width", 1)
               .attr("fill", function(d) {
					return d.color;
			   });
		
			var counter = 0;
			d3.select("svg")
				.on("click", function(e) {
					svg.selectAll("path")
						.transition()
						.duration(2000)
						.ease("linear")
						.attr("d", function(d) {
							return lineFunction(lizard ? getLizardPoints(d.r, d.x, d.y, d.angle  + counter * 120) : getGenericPoints(d.r, d.x, d.y, d.angle + counter * 120));
						});					;
					if (!lizard) {
						counter++;			
						svg.selectAll("path")
						.transition()
						.delay(2000)
						.duration(0)
						.attr("d", function(d) {
							return lineFunction(getGenericPoints(d.r, d.x, d.y, d.angle + counter * 120));
						});					;
					}
					lizard = !lizard;
			});
		</script>
 	  </section>
    </div>
    <script src="javascripts/scale.fix.js"></script>
  </body>
</html>